<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
<META NAME="generator" CONTENT="http://txt2tags.org">
<TITLE>reshape</TITLE>
</HEAD><BODY BGCOLOR="white" TEXT="black">
<CENTER>
<H1>reshape</H1>
</CENTER>


<PRE>
  
  . list
  
       +---------------------+
       | id    fruit   price |
       |---------------------|
    1. |  1    apple      10 |
    2. |  1   banana       5 |
    3. |  2    apple      10 |
    4. |  2   cherry       8 |
    5. |  3   banana       5 |
       |---------------------|
    6. |  3   cheery       8 |
       +---------------------+
  
</PRE>

<P>
以這份資料為例，我們有 6 個 observations，
我們想改寫成每一個 observations 表示一個 id 吃了什麼水果，
也就是說，我們想將第 1, 2 筆資料改寫成
</P>

<PRE>
       +----------------------------------------+
       | id   fruit1   price1   fruit2   price2 |
       |----------------------------------------|
    1. |  1    apple       10   banana        5 |
       +----------------------------------------+
</PRE>

<P>
這時候，我們要使用 stata 的 reshpae 指令。
</P>
<P>
要使用 reshape 前，要先將資料以 key 分組，
在本例中，我們以 id 分組，
並把相同 key 之下的資料加上組內 index。
</P>

<PRE>
  . bysort id: gen j = _n
  
  . list
  
       +-------------------------+
       | id    fruit   price   j |
       |-------------------------|
    1. |  1    apple      10   1 |
    2. |  1   banana       5   2 |
    3. |  2    apple      10   1 |
    4. |  2   cherry       8   2 |
    5. |  3   banana       5   1 |
       |-------------------------|
    6. |  3   cheery       8   2 |
       +-------------------------+
  
</PRE>

<P>
接著使用 reshape 指令，
告訴 stata 我們要將哪些變數 unstack，
在本例中，我們選擇 fruit, price，
接者指定 key 與組內 index，
指令分別為 i(key) j(within_group_index)
</P>

<PRE>
  
  . reshape wide fruit price, i(id) j(j)
  (note: j = 1 2)
  
  Data                               long   -&gt;   wide
  -----------------------------------------------------------------------------
  Number of obs.                        6   -&gt;       3
  Number of variables                   4   -&gt;       5
  j variable (2 values)                 j   -&gt;   (dropped)
  xij variables:
                                    fruit   -&gt;   fruit1 fruit2
                                    price   -&gt;   price1 price2
  -----------------------------------------------------------------------------
  
  . list
  
       +----------------------------------------+
       | id   fruit1   price1   fruit2   price2 |
       |----------------------------------------|
    1. |  1    apple       10   banana        5 |
    2. |  2    apple       10   cherry        8 |
    3. |  3   banana        5   cheery        8 |
       +----------------------------------------+
  
  . 
  
</PRE>

<P>
注意， reshape 時必須確定沒有被指定要 unstack 的變數必須在組內的值相同，
否則會有問題。
</P>

<PRE>
  . list
  
       +-----------------------------------------+
       | id    fruit   price   quantity     name |
       |-----------------------------------------|
    1. |  1    apple      10          5      Amy |
    2. |  1   banana       5          7      Amy |
    3. |  2    apple      10          8    Berry |
    4. |  2   cherry       8          2    Berry |
    5. |  3   banana       5          4   Celine |
       |-----------------------------------------|
    6. |  3   cheery       8          5   Celine |
       +-----------------------------------------+
       
  . bysort id: gen j = _n
  
  . reshape wide fruit price, i(id) j(j)
  (note: j = 1 2)
  variable quantity not constant within id
      Your data are currently long.  You are performing a reshape wide.  You
      typed something like
  
          . reshape wide a b, i(id) j(j)
  
      There are variables other than a, b, id, j in your data.  They must be
      constant within id because that is the only way they can fit into wide
      data without loss of information.
  
      The variable or variables listed above are not constant within id.
      Perhaps the values are in error.  Type reshape error for a list of the
      problem observations.
  
      Either that, or the values vary because they should vary, in which case
      you must either add the variables to the list of xij variables to be
      reshaped, or drop them.
  r(9);
  
</PRE>

<P>
因為 quantity 在組內的值不同，因此出現問題。
把這個問題修正後，就可以正確 reshape。
</P>

<PRE>
  . reshape wide fruit price quantity, i(id) j(j)
  . list
  
       +-----------------------------------------------------------------------+
       | id   fruit1   price1   quanti~1   fruit2   price2   quanti~2     name |
       |-----------------------------------------------------------------------|
    1. |  1    apple       10          5   banana        5          7      Amy |
    2. |  2    apple       10          8   cherry        8          2    Berry |
    3. |  3   banana        5          4   cheery        8          5   Celine |
       +-----------------------------------------------------------------------+
  
</PRE>

<!-- html code generated by txt2tags 2.6 (http://txt2tags.org) -->
<!-- cmdline: txt2tags -t html reshape.t2t -->
</BODY></HTML>
